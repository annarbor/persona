<!DOCTYPE HTML>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>Persona</title>
<meta name="viewport" content="width=device-width, initial-scale=1"> 
<link rel="stylesheet" href="http://code.jquery.com/mobile/1.0/jquery.mobile-1.0.min.css" />
<script type="text/javascript" src="http://code.jquery.com/jquery-1.6.4.min.js"></script>
<script type="text/javascript" src="http://code.jquery.com/mobile/1.0/jquery.mobile-1.0.min.js"></script>
<script type="text/javascript" src="https://login.persona.org/include.js"></script>
<script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.1.5.min.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
    Parse.initialize("uQSC54eGu2hDDVXbfjkwbcPbVxlJaN2x1vUgZh6K", "9zJh2WvfFjZWBW0DKJd84KXmDmSDFm5IKKFsZGsA");

    var signinLink = document.getElementById('signin');
    if (signinLink) {
      signinLink.onclick = function() { navigator.id.request(); };
    };
 
    var signoutLink = document.getElementById('signout');
    if (signoutLink) {
      signoutLink.onclick = function() { navigator.id.logout(); };
    };

    var currentUser = '';
    var currentUserId = '';
 
    navigator.id.watch({
      loggedInUser: currentUser,
      onlogin: function(assertion) {
        // ユーザがログインしました！ ここで必要なことは:
        // 1. 検証してセッションを作成するため、アサーションをバックエンドに送信する。
        Parse.Cloud.run('signin', {"assertion" : assertion}, {
          success: function(result) {
            // バックエンド側の処理(Parseが3rd PartyへのHTTPリクエストの対応待ち
            //$.ajax({ /* <-- この例では jQuery を使いますが、他のものも使えます */
            //  type: 'POST',
            //  url: 'https://verifier.login.persona.org/verify',
            //  data: "assertion=" + assertion +"&audience=https://annarbor.github.com/:80",
            //  success: function(res, status, xhr) { console.log("ok"); $('#signin_status').html("Welcome: " + currentUser); },
            //  error: function(res, status, xhr) { console.error("login failure" + res); }
            //});
        // 2. UI を更新する。
            currentUserId = result.id;
            currentUser = result.email;
            var text = "Welcome: " + currentUser;
            $('#signin_status').html(text);
          },
          error: function(error) {
            console.error("watch signin error:" + error.code); 
          }
        });
      },
      onlogout: function() {
        // ユーザがログアウトしました！ ここで必要なことは:
        // リダイレクトするかバックエンドの呼び出しを行って、ユーザのセッションを破棄する。
          Parse.Cloud.run('signout', {}, {
            success: function(result) {
              currentUser = '';
              currentUserId = '';
              $('#signin_status').html("Please Sign-In");
            },
            error: function(error) {
              console.log("watch signout error:" + error.code); 
            }
          });
      }
    });

  });
</script>
<style>
</style>
</head>

<body>
<!-- ページ -->
<div data-role="page" id="top" data-add-back-btn="true">
<!-- ヘッダー -->
<div data-role="header" id="signin_header">
<h1 id="signin_status">Please Sign-In</h1>
</div>
<!-- コンテンツ -->
<div data-role="content">
<ul data-role="listview">
<li><a href="#signin" id="signin">Sign In with Persona</a></li>
<li><a href="#signout" id="signout">Sign Out</a></li>
</ul>
</div>
<!-- フッター -->
<div data-role="footer">
<h4>フッター</h4-->
</div>
</div>
</body>

</html>
